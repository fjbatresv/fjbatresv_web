name: SonarCloud

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

jobs:
  sonarcloud:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Ensure Chrome/Chromium
        run: |
          set -e
          BIN="$(which google-chrome || which google-chrome-stable || which chromium-browser || true)"
          if [ -z "$BIN" ]; then
            sudo apt-get update
            sudo apt-get install -y chromium-browser || sudo apt-get install -y chromium
            BIN="$(which chromium-browser || which chromium || true)"
          fi
          if [ -z "$BIN" ]; then
            echo "Chrome/Chromium not found" >&2
            exit 1
          fi
          echo "Using CHROME_BIN=$BIN"
          echo "CHROME_BIN=$BIN" >> "$GITHUB_ENV"
          "$BIN" --version

      - name: Lint
        run: npm run lint

      - name: Test (coverage)
        env:
          CI: "true"
        run: npm run test:coverage

      - name: Build
        run: npm run build

      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@ffc3010689be73b8e5ae0c57ce35968afd7909e8 # v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
